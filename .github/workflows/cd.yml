name: CD - DEV Dashboard (Netlify)
on:
    workflow_run:
        workflows: CI
        types:
            - completed
        branches:
            - main
        paths:
            - "apps/dashboard/**"

jobs:
    build_and_deploy-failure:
        runs-on: ubuntu-latest
        if: ${{ github.event.workflow_run.conclusion == 'failure' }}

        steps:
            - run: echo 'The triggering workflow failed'

    build_and_deploy-success:
        runs-on: ubuntu-latest
        if: ${{ github.event.workflow_run.conclusion == 'success' }}

        steps:
            - name: Checkout code
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Setup Nodejs
              uses: actions/setup-node@v4
              with:
                  node-version: 20.12.2

            - name: Setup pnpm
              uses: pnpm/action-setup@v3
              with:
                  version: 8.15.7

            - name: Restore cached npm dependencies
              id: cache-dependencies-restore
              uses: actions/cache/restore@v4
              with:
                  path: |
                      node_modules
                      ~/.cache/Cypress # needed for the Cypress binary
                  key: npm-dependencies-${{ hashFiles('pnpm-lock.yaml') }}

            - name: Install monorepo dependencies
              run: pnpm install --frozen-lockfile

            - name: Cache npm dependencies
              id: cache-dependencies-save
              uses: actions/cache/save@v4
              with:
                  path: |
                      node_modules
                      ~/.cache/Cypress # needed for the Cypress binary
                  key: ${{ steps.cache-dependencies-restore.outputs.cache-primary-key }}

            # --distribute-on="5 linux-medium-js"
            - name: Start Nx Cloud
              run: pnpm exec nx-cloud start-ci-run --stop-agents-after="build" --use-dte-by-default=false

            - name: Set Nx SHA
              uses: nrwl/nx-set-shas@v4

            - name: Build Astro
              run: pnpm exec nx run @kinkoi/dashboard:build

            - name: Deploy to Netlify
              run: netlify deploy --site ${{ secrets.NETLIFY_SITE_ID }} --auth ${{ secrets.NETLIFY_API_TOKEN }} --filter api --dir=./apps/dashboard/dist --prod
