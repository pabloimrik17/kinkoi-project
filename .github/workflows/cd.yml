name: build and deploy
on:
    push:
        branches:
            - "main"
jobs:
    build_and_deploy:
        name: build and deploy
        runs-on: ubuntu-latest
        steps:
            - name: Checkout
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: 20.12.2
            - name: Setup Pnpm
              uses: pnpm/action-setup@v3
              with:
                  version: 8.15.7

            - name: Restore cached npm dependencies
              id: cache-dependencies-restore
              uses: actions/cache/restore@v4
              with:
                  path: |
                      node_modules
                      ~/.cache/Cypress # needed for the Cypress binary
                  key: npm-dependencies-${{ hashFiles('pnpm-lock.yaml') }}

            - name: Install monorepo dependencies
              run: pnpm install --frozen-lockfile

            - name: Cache npm dependencies
              id: cache-dependencies-save
              uses: actions/cache/save@v4
              with:
                  path: |
                      node_modules
                      ~/.cache/Cypress # needed for the Cypress binary
                  key: ${{ steps.cache-dependencies-restore.outputs.cache-primary-key }}

            - name: Setup Terraform
              uses: hashicorp/setup-terraform@v1

            - name: Terraform Init
              run: terraform init
              env:
                  NETLIFY_API_TOKEN: ${{ secrets.NETLIFY_API_TOKEN }}

            - name: Terraform Plan
              run: terraform plan -no-color
              env:
                  NETLIFY_API_TOKEN: ${{ secrets.NETLIFY_API_TOKEN }}

            - name: Terraform Apply
              run: terraform apply -auto-approve -no-color
              env:
                  NETLIFY_API_TOKEN: ${{ secrets.NETLIFY_API_TOKEN }}
